<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add Link - jonplummer.com</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      line-height: 1.6;
      color: #333;
      background: #f5f5f5;
      padding: 1rem;
      max-width: 600px;
      margin: 0 auto;
    }

    h1 {
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
      color: #222;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }

    .required {
      color: #d32f2f;
    }

    input[type="url"],
    input[type="text"],
    input[type="date"],
    textarea {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #ddd;
      border-radius: 4px;
      font-size: 1rem;
      font-family: inherit;
      transition: border-color 0.2s;
    }

    input[type="url"]:focus,
    input[type="text"]:focus,
    input[type="date"]:focus,
    textarea:focus {
      outline: none;
      border-color: #1976d2;
    }

    textarea {
      min-height: 100px;
      resize: vertical;
    }

    .error {
      color: #d32f2f;
      font-size: 0.875rem;
      margin-top: 0.25rem;
      display: none;
    }

    .error.show {
      display: block;
    }

    .help-text {
      font-size: 0.875rem;
      color: #666;
      margin-top: 0.25rem;
    }

    button {
      background: #1976d2;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
      transition: background 0.2s;
    }

    button:hover:not(:disabled) {
      background: #1565c0;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .message {
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
      display: none;
    }

    .message.show {
      display: block;
    }

    .message.success {
      background: #e8f5e9;
      color: #2e7d32;
      border: 1px solid #4caf50;
    }

    .message.error {
      background: #ffebee;
      color: #c62828;
      border: 1px solid #ef5350;
    }

    .token-setup {
      background: #fff3cd;
      border: 1px solid #ffc107;
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1.5rem;
    }

    .token-setup h2 {
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }

    .token-setup p {
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }

    .token-setup code {
      background: #f5f5f5;
      padding: 0.2rem 0.4rem;
      border-radius: 3px;
      font-size: 0.85rem;
    }

    .token-input-group {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .token-input-group input {
      flex: 1;
    }

    .token-input-group button {
      width: auto;
      padding: 0.75rem 1rem;
    }

    .hidden {
      display: none;
    }

    @media (max-width: 600px) {
      body {
        padding: 0.5rem;
      }

      h1 {
        font-size: 1.25rem;
      }

      button {
        padding: 1rem;
        font-size: 1.1rem;
      }
    }
  </style>
</head>
<body>
  <h1>Add Link</h1>

  <div id="tokenSetup" class="token-setup">
    <h2>GitHub Token Required</h2>
    <p>To add links, you need a GitHub Personal Access Token with <code>repo</code> scope.</p>
    <p><strong>Create token:</strong> <a href="https://github.com/settings/tokens/new" target="_blank">GitHub Settings → Developer settings → Personal access tokens → Tokens (classic)</a></p>
    <p>Select <code>repo</code> scope, then copy the token and paste it below.</p>
    <div class="token-input-group">
      <input type="password" id="tokenInput" placeholder="Paste GitHub token here" />
      <button type="button" id="saveTokenBtn">Save Token</button>
    </div>
    <p class="help-text">Token is stored in your browser only. It's never sent to any server except GitHub.</p>
  </div>

  <div id="message" class="message"></div>

  <form id="linkForm">
    <div class="form-group">
      <label for="url">URL <span class="required">*</span></label>
      <input type="url" id="url" name="url" required placeholder="https://example.com/article" />
      <div class="error" id="urlError"></div>
    </div>

    <div class="form-group">
      <label for="title">Title <span class="required">*</span></label>
      <input type="text" id="title" name="title" required placeholder="Article title" />
      <div class="error" id="titleError"></div>
    </div>

    <div class="form-group">
      <label for="description">Description</label>
      <textarea id="description" name="description" placeholder="Optional description or quote"></textarea>
      <div class="error" id="descriptionError"></div>
      <div class="help-text">Can include quotes, colons, and markdown. Will be properly formatted in YAML.</div>
    </div>

    <div class="form-group">
      <label for="date">Date <span class="required">*</span></label>
      <input type="date" id="date" name="date" required />
      <div class="error" id="dateError"></div>
      <div class="help-text">Defaults to today. Links are grouped by date.</div>
    </div>

    <button type="submit" id="submitBtn">Add Link</button>
  </form>

  <script>
    // Configuration
    const GITHUB_OWNER = 'jplummer';
    const GITHUB_REPO = 'jonplummer-11ty';
    const LINKS_FILE_PATH = 'src/_data/links.yaml';
    const GITHUB_API_BASE = 'https://api.github.com';

    // DOM elements
    const tokenSetup = document.getElementById('tokenSetup');
    const tokenInput = document.getElementById('tokenInput');
    const saveTokenBtn = document.getElementById('saveTokenBtn');
    const linkForm = document.getElementById('linkForm');
    const messageDiv = document.getElementById('message');
    const submitBtn = document.getElementById('submitBtn');

    // Check for saved token on load
    let githubToken = localStorage.getItem('github_token');
    if (githubToken) {
      tokenSetup.classList.add('hidden');
      linkForm.classList.remove('hidden');
    } else {
      linkForm.classList.add('hidden');
    }

    // Save token
    saveTokenBtn.addEventListener('click', () => {
      const token = tokenInput.value.trim();
      if (!token) {
        showMessage('Please enter a token', 'error');
        return;
      }
      localStorage.setItem('github_token', token);
      githubToken = token;
      tokenSetup.classList.add('hidden');
      linkForm.classList.remove('hidden');
      showMessage('Token saved!', 'success');
    });

    // Set default date to today
    const dateInput = document.getElementById('date');
    const today = new Date().toISOString().split('T')[0];
    dateInput.value = today;

    // Form validation
    function validateForm() {
      const url = document.getElementById('url').value.trim();
      const title = document.getElementById('title').value.trim();
      const description = document.getElementById('description').value.trim();
      const date = document.getElementById('date').value;

      let isValid = true;

      // Clear previous errors
      document.querySelectorAll('.error').forEach(el => {
        el.classList.remove('show');
        el.textContent = '';
      });

      // Validate URL
      if (!url) {
        showError('urlError', 'URL is required');
        isValid = false;
      } else {
        try {
          const urlObj = new URL(url);
          if (!['http:', 'https:'].includes(urlObj.protocol)) {
            showError('urlError', 'URL must start with http:// or https://');
            isValid = false;
          }
        } catch (e) {
          showError('urlError', 'URL must be a valid URL');
          isValid = false;
        }
      }

      // Validate title
      if (!title) {
        showError('titleError', 'Title is required');
        isValid = false;
      } else if (title.length < 1 || title.length > 1000) {
        showError('titleError', 'Title must be between 1 and 1000 characters');
        isValid = false;
      }

      // Validate date
      if (!date) {
        showError('dateError', 'Date is required');
        isValid = false;
      } else if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) {
        showError('dateError', 'Date must be in YYYY-MM-DD format');
        isValid = false;
      }

      return isValid;
    }

    function showError(elementId, message) {
      const errorEl = document.getElementById(elementId);
      errorEl.textContent = message;
      errorEl.classList.add('show');
    }

    function showMessage(message, type) {
      messageDiv.textContent = message;
      messageDiv.className = `message ${type} show`;
      setTimeout(() => {
        messageDiv.classList.remove('show');
      }, 5000);
    }

    // Format YAML string (simple version for client-side)
    function formatYamlString(value) {
      if (!value || typeof value !== 'string') {
        return value;
      }

      // Check if needs quoting
      const needsQuoting = /[:#|>&*!%@`'"\n\r]/.test(value) || 
                           /^\s|\s$/.test(value) ||
                           /^[0-9-]/.test(value) ||
                           ['true', 'false', 'null', 'yes', 'no', 'on', 'off'].includes(value.toLowerCase());

      if (!needsQuoting) {
        return value;
      }

      // Escape and quote
      if (value.includes('"') && value.includes("'")) {
        return `"${value.replace(/\\/g, '\\\\').replace(/"/g, '\\"')}"`;
      } else if (value.includes('"')) {
        return `"${value.replace(/\\/g, '\\\\').replace(/"/g, '\\"')}"`;
      } else if (value.includes("'")) {
        return `"${value.replace(/\\/g, '\\\\')}"`;
      } else {
        return `"${value.replace(/\\/g, '\\\\')}"`;
      }
    }

    // Format link for YAML
    function formatLinkYaml(link) {
      const parts = [];
      parts.push(`  - url: ${formatYamlString(link.url)}`);
      parts.push(`    title: ${formatYamlString(link.title)}`);
      if (link.description && link.description.trim()) {
        parts.push(`    description: ${formatYamlString(link.description)}`);
      }
      return parts.join('\n');
    }

    // Add link to YAML content (client-side parsing)
    // Note: This is a simplified parser. For production, consider using js-yaml library
    function addLinkToYaml(yamlContent, date, link) {
      const result = {};
      const lines = yamlContent.split('\n');
      let currentDate = null;
      let currentLinks = [];
      let i = 0;

      while (i < lines.length) {
        const line = lines[i].trim();
        
        // Date key (YYYY-MM-DD:)
        if (/^\d{4}-\d{2}-\d{2}:$/.test(line)) {
          if (currentDate && currentLinks.length > 0) {
            result[currentDate] = currentLinks;
          }
          currentDate = line.replace(':', '');
          currentLinks = [];
          i++;
        }
        // Link entry start (- url:)
        else if (line.startsWith('- url:')) {
          const linkObj = {};
          
          // Extract URL
          const urlMatch = line.match(/url:\s*(.+)$/);
          if (urlMatch) {
            linkObj.url = unquoteYamlString(urlMatch[1].trim());
          }
          
          i++;
          
          // Look for title (next line, indented)
          if (i < lines.length && lines[i].trim().startsWith('title:')) {
            const titleMatch = lines[i].trim().match(/title:\s*(.+)$/);
            if (titleMatch) {
              linkObj.title = unquoteYamlString(titleMatch[1].trim());
            }
            i++;
          }
          
          // Look for description (next line, indented, optional)
          if (i < lines.length && lines[i].trim().startsWith('description:')) {
            const descMatch = lines[i].trim().match(/description:\s*(.+)$/);
            if (descMatch) {
              linkObj.description = unquoteYamlString(descMatch[1].trim());
            }
            i++;
          }
          
          if (linkObj.url && linkObj.title) {
            currentLinks.push(linkObj);
          }
        }
        // Empty line or other content - skip
        else {
          i++;
        }
      }

      // Add last date group
      if (currentDate && currentLinks.length > 0) {
        result[currentDate] = currentLinks;
      }

      // Add new link
      if (!result[date]) {
        result[date] = [];
      }
      result[date].push({
        url: link.url.trim(),
        title: link.title.trim(),
        description: link.description ? link.description.trim() : undefined
      });

      // Sort dates (newest first)
      const sortedDates = Object.keys(result).sort((a, b) => b.localeCompare(a));

      // Format back to YAML
      const output = [];
      for (const dateKey of sortedDates) {
        output.push(`${dateKey}:`);
        for (const linkItem of result[dateKey]) {
          output.push(formatLinkYaml(linkItem));
        }
        if (dateKey !== sortedDates[sortedDates.length - 1]) {
          output.push('');
        }
      }

      return output.join('\n') + '\n';
    }

    // Helper to unquote YAML strings (handles both single and double quotes)
    function unquoteYamlString(str) {
      if (!str) return str;
      // Remove surrounding quotes if present
      if ((str.startsWith('"') && str.endsWith('"')) || 
          (str.startsWith("'") && str.endsWith("'"))) {
        str = str.slice(1, -1);
      }
      // Unescape double quotes
      str = str.replace(/\\"/g, '"');
      // Unescape backslashes
      str = str.replace(/\\\\/g, '\\');
      return str;
    }

    // GitHub API: Get file
    async function getFile() {
      const url = `${GITHUB_API_BASE}/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${LINKS_FILE_PATH}`;
      const response = await fetch(url, {
        headers: {
          'Authorization': `token ${githubToken}`,
          'Accept': 'application/vnd.github.v3+json'
        }
      });

      if (!response.ok) {
        if (response.status === 404) {
          throw new Error('links.yaml file not found in repository');
        }
        if (response.status === 401) {
          throw new Error('Invalid GitHub token. Please check your token and try again.');
        }
        throw new Error(`GitHub API error: ${response.status} ${response.statusText}`);
      }

      const data = await response.json();
      const content = atob(data.content.replace(/\n/g, ''));
      return { content, sha: data.sha };
    }

    // GitHub API: Update file
    async function updateFile(content, sha, commitMessage) {
      const url = `${GITHUB_API_BASE}/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${LINKS_FILE_PATH}`;
      const encodedContent = btoa(unescape(encodeURIComponent(content)));

      const response = await fetch(url, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${githubToken}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: commitMessage,
          content: encodedContent,
          sha: sha
        })
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        if (response.status === 409) {
          throw new Error('File was modified. Please refresh and try again.');
        }
        if (response.status === 401) {
          throw new Error('Invalid GitHub token. Please check your token and try again.');
        }
        throw new Error(`GitHub API error: ${errorData.message || response.statusText}`);
      }

      return await response.json();
    }

    // Form submission
    linkForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!validateForm()) {
        return;
      }

      if (!githubToken) {
        showMessage('GitHub token is required', 'error');
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'Adding...';

      try {
        // Get current file
        const { content: currentContent, sha } = await getFile();

        // Prepare link data
        const link = {
          url: document.getElementById('url').value.trim(),
          title: document.getElementById('title').value.trim(),
          description: document.getElementById('description').value.trim() || undefined
        };
        const date = document.getElementById('date').value;

        // Add link to YAML
        const newContent = addLinkToYaml(currentContent, date, link);

        // Commit to GitHub
        const commitMessage = `Add link: ${link.title}`;
        await updateFile(newContent, sha, commitMessage);

        // Success!
        showMessage(`Link added successfully!`, 'success');
        linkForm.reset();
        dateInput.value = today; // Reset date to today

        // Option to add another
        setTimeout(() => {
          document.getElementById('url').focus();
        }, 500);

      } catch (error) {
        showMessage(`Error: ${error.message}`, 'error');
        console.error('Error adding link:', error);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Add Link';
      }
    });
  </script>
</body>
</html>

